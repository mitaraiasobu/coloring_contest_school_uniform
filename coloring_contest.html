<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¨ å¡—ã‚Šçµµã‚³ãƒ³ãƒ†ã‚¹ãƒˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-6">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-8 text-purple-800">
      ğŸ¨ å¡—ã‚Šçµµã‚³ãƒ³ãƒ†ã‚¹ãƒˆ
    </h1>

    <!-- èª­ã¿è¾¼ã¿çŠ¶æ…‹ -->
    <div id="loadingStatus" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6 hidden">
      <p class="text-yellow-700">â³ ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div id="errorStatus" class="bg-red-100 border-l-4 border-red-500 p-4 mb-6 hidden">
      <p class="text-red-700 font-bold">âŒ ä¸€éƒ¨ã®ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>
      <ul id="errorList" class="text-sm text-red-600 ml-7 mt-2"></ul>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <div id="debugInfo" class="bg-blue-100 border-l-4 border-blue-500 p-4 mb-6">
      <p class="text-blue-700 font-bold mb-2">ğŸ“Š ç”»åƒèª­ã¿è¾¼ã¿çŠ¶æ…‹:</p>
      <div id="imageStatus" class="grid grid-cols-4 gap-2 text-sm"></div>
      <p id="loadCount" class="text-blue-600 text-sm mt-2"></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
      <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ -->
      <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6">
        <div class="border-4 border-purple-200 rounded-lg overflow-hidden bg-white">
          <canvas id="canvas" class="w-full h-auto max-w-full"></canvas>
        </div>
        <div class="mt-4 flex justify-center lg:justify-end">
          <button id="downloadBtn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm lg:text-base">
            ğŸ“¥ ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
      <div class="grid grid-cols-2 gap-4 lg:grid-cols-1 lg:space-y-0 lg:gap-6">
        <!-- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ -->
        <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6">
          <h2 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4">ğŸ¨ ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ</h2>
          <div id="colorPalette" class="grid grid-cols-6 gap-2 mb-4"></div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">âœ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼</label>
            <input type="color" id="customColor" value="#ff0000" class="w-full h-12 rounded cursor-pointer" style="background: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);">
          </div>
          <button id="applyColorBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition-colors text-sm lg:text-base">
            é¸æŠã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¡—ã‚‹
          </button>
        </div>

        <!-- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ« -->
        <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6">
          <div class="flex justify-between items-center mb-3 lg:mb-4">
            <h2 class="text-lg lg:text-xl font-bold">ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>
            <button id="resetBtn" class="text-xs lg:text-sm bg-gray-200 px-3 py-2 rounded hover:bg-gray-300 transition-colors">
              ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
          <div id="layerList" class="space-y-2 max-h-64 lg:max-h-96 overflow-y-auto"></div>
        </div>
      </div>
    </div>

    <!-- ä½¿ã„æ–¹ -->
    <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
      <h3 class="text-lg font-bold mb-3">ğŸ“– ä½¿ã„æ–¹</h3>
      <ol class="list-decimal list-inside space-y-2 text-gray-700">
        <li>ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã‹ã‚‰å¡—ã‚ŠãŸã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ(ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã¯å›ºå®šã§å¤‰æ›´ä¸å¯)</li>
        <li>ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‹ã‚‰å¥½ããªè‰²ã‚’é¸æŠ</li>
        <li>ã€Œé¸æŠã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¡—ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
        <li>ğŸ‘ï¸ ã‚¢ã‚¤ã‚³ãƒ³ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ</li>
        <li>å®Œæˆã—ãŸã‚‰ã€Œç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜</li>
      </ol>
    </div>
  </div>

  <script>
    // ç”»åƒURLã®è¨­å®š
    const layerImageUrls = {
      1: './images/1.png',
      2: './images/2.png',
      3: './images/3.png',
      4: './images/4.png',
      5: './images/5.png',
      6: './images/6.png',
      7: './images/7.png',
      8: './images/8.png',
      9: './images/9.png',
      10: './images/10.png',
      11: './images/11.png',
      12: './images/12.png',
      13: './images/13.png',
    };

    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
    const colorPalette = [
      '#ff0000', '#ff4500', '#ff8c00', '#ffd700', '#ffff00', '#9acd32',
      '#00ff00', '#00fa9a', '#00ffff', '#1e90ff', '#0000ff', '#8a2be2',
      '#ff00ff', '#ff1493', '#ff69b4', '#000000', '#808080', '#ffffff'
    ];

    // çŠ¶æ…‹ç®¡ç†
    let selectedColor = '#ff0000';
    let selectedLayer = 'background';
    let loadedImages = {};
    let imageLoadStatus = {};
    let layers = [
      { id: 'background', name: 'èƒŒæ™¯', color: '#ffffff', visible: true, isBackground: true },
      { id: 2, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼2', color: null, visible: true },
      { id: 3, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼3', color: null, visible: true },
      { id: 4, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼4', color: null, visible: true },
      { id: 5, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼5', color: null, visible: true },
      { id: 6, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼6', color: null, visible: true },
      { id: 7, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼7', color: null, visible: true },
      { id: 8, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼8', color: null, visible: true },
      { id: 9, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼9', color: null, visible: true },
      { id: 10, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼10', color: null, visible: true },
      { id: 11, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼11', color: null, visible: true },
      { id: 12, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼12', color: null, visible: true },
      { id: 13, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼13', color: null, visible: true },
    ];
    let fixedLayerVisible = true;

    // DOMè¦ç´ 
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const customColorInput = document.getElementById('customColor');

    // åˆæœŸåŒ–
    function init() {
      loadImages();
      renderColorPalette();
      renderLayerList();
      setupEventListeners();
    }

    // ç”»åƒã‚’èª­ã¿è¾¼ã‚€
    function loadImages() {
      document.getElementById('loadingStatus').classList.remove('hidden');
      let loadCount = 0;
      const totalImages = Object.keys(layerImageUrls).length;

      Object.entries(layerImageUrls).forEach(([id, url]) => {
        imageLoadStatus[id] = 'loading';
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = () => {
          loadedImages[id] = img;
          imageLoadStatus[id] = 'loaded';
          loadCount++;
          updateLoadStatus(loadCount, totalImages);
          
          if (loadCount === totalImages) {
            document.getElementById('loadingStatus').classList.add('hidden');
            document.getElementById('debugInfo').classList.add('hidden');
            drawCanvas();
          }
        };
        
        img.onerror = () => {
          imageLoadStatus[id] = 'error';
          loadCount++;
          updateLoadStatus(loadCount, totalImages);
          
          if (loadCount === totalImages) {
            document.getElementById('loadingStatus').classList.add('hidden');
            document.getElementById('debugInfo').classList.add('hidden');
            showErrors();
          }
        };
        
        img.src = url;
      });
    }

    // èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’æ›´æ–°
    function updateLoadStatus(loaded, total) {
      const statusDiv = document.getElementById('imageStatus');
      statusDiv.innerHTML = '';
      
      Object.entries(imageLoadStatus).forEach(([id, status]) => {
        const div = document.createElement('div');
        div.className = 'text-blue-600';
        const emoji = status === 'loaded' ? 'âœ…' : status === 'loading' ? 'â³' : 'âŒ';
        div.textContent = `ãƒ¬ã‚¤ãƒ¤ãƒ¼${id}: ${emoji}`;
        statusDiv.appendChild(div);
      });
      
      document.getElementById('loadCount').textContent = 
        `èª­ã¿è¾¼ã¿æ¸ˆã¿: ${Object.values(imageLoadStatus).filter(s => s === 'loaded').length} / ${total}`;
    }

    // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    function showErrors() {
      const errors = Object.entries(imageLoadStatus).filter(([_, status]) => status === 'error');
      if (errors.length > 0) {
        document.getElementById('errorStatus').classList.remove('hidden');
        const errorList = document.getElementById('errorList');
        errorList.innerHTML = '';
        errors.forEach(([id]) => {
          const li = document.createElement('li');
          li.textContent = `ãƒ¬ã‚¤ãƒ¤ãƒ¼${id}: èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼`;
          errorList.appendChild(li);
        });
      }
    }

    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‚’æç”»
    function renderColorPalette() {
      const paletteDiv = document.getElementById('colorPalette');
      colorPalette.forEach(color => {
        const btn = document.createElement('button');
        btn.className = 'w-8 h-8 rounded-full border-2 transition-transform hover:scale-110';
        btn.style.backgroundColor = color;
        btn.onclick = () => {
          selectedColor = color;
          customColorInput.value = color;
          updatePaletteSelection();
        };
        paletteDiv.appendChild(btn);
      });
      updatePaletteSelection();
    }

    // ãƒ‘ãƒ¬ãƒƒãƒˆã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
    function updatePaletteSelection() {
      const buttons = document.querySelectorAll('#colorPalette button');
      buttons.forEach(btn => {
        if (btn.style.backgroundColor === selectedColor || 
            rgbToHex(btn.style.backgroundColor) === selectedColor) {
          btn.className = 'w-8 h-8 rounded-full border-2 border-purple-500 scale-110 transition-transform';
        } else {
          btn.className = 'w-8 h-8 rounded-full border-2 border-gray-300 transition-transform hover:scale-110';
        }
      });
    }

    // RGB to Hexå¤‰æ›
    function rgbToHex(rgb) {
      const result = rgb.match(/\d+/g);
      if (!result) return rgb;
      return '#' + result.map(x => {
        const hex = parseInt(x).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»
    function renderLayerList() {
      const listDiv = document.getElementById('layerList');
      listDiv.innerHTML = '';

      // å›ºå®šãƒ¬ã‚¤ãƒ¤ãƒ¼(ãƒ¬ã‚¤ãƒ¤ãƒ¼1)
      const fixedDiv = document.createElement('div');
      fixedDiv.className = 'flex items-center gap-2 p-3 rounded-lg border-2 border-gray-400 bg-gray-100';
      fixedDiv.innerHTML = `
        <button onclick="toggleFixedLayer()" class="flex-shrink-0">
          ${fixedLayerVisible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
        </button>
        <div class="w-8 h-8 rounded border-2 border-gray-300 flex-shrink-0 bg-white"></div>
        <span class="font-medium flex-grow">ãƒ¬ã‚¤ãƒ¤ãƒ¼1(å›ºå®š)</span>
        <span class="text-xs text-gray-500">ğŸ”’</span>
      `;
      listDiv.appendChild(fixedDiv);

      // ãã®ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼(é †ç•ªé€šã‚Š)
      layers.forEach(layer => {
        const div = document.createElement('div');
        const isSelected = selectedLayer === layer.id;
        div.className = `flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer transition-colors ${
          isSelected ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-gray-300'
        }`;
        div.onclick = () => selectLayer(layer.id);
        
        div.innerHTML = `
          <button onclick="event.stopPropagation(); toggleLayerVisibility('${layer.id}')" class="flex-shrink-0">
            ${layer.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
          </button>
          <div class="w-8 h-8 rounded border-2 border-gray-300 flex-shrink-0" style="background-color: ${layer.color || '#ffffff'}"></div>
          <span class="font-medium flex-grow">${layer.name}</span>
        `;
        listDiv.appendChild(div);
      });
    }

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ
    function selectLayer(layerId) {
      selectedLayer = layerId;
      renderLayerList();
      updateApplyButton();
    }

    // é©ç”¨ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateApplyButton() {
      const btn = document.getElementById('applyColorBtn');
      if (selectedLayer === 1) {
        btn.className = 'w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-bold cursor-not-allowed text-sm lg:text-base';
        btn.textContent = 'å›ºå®šãƒ¬ã‚¤ãƒ¤ãƒ¼(å¤‰æ›´ä¸å¯)';
        btn.disabled = true;
      } else {
        btn.className = 'w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition-colors text-sm lg:text-base';
        btn.textContent = 'é¸æŠã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¡—ã‚‹';
        btn.disabled = false;
      }
    }

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    window.toggleLayerVisibility = function(layerId) {
      const layer = layers.find(l => l.id == layerId);
      if (layer) {
        layer.visible = !layer.visible;
        renderLayerList();
        drawCanvas();
      }
    };

    // å›ºå®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
    window.toggleFixedLayer = function() {
      fixedLayerVisible = !fixedLayerVisible;
      renderLayerList();
      drawCanvas();
    };

    // è‰²ã‚’é©ç”¨
    function applyColor() {
      if (selectedLayer === 1) return;
      
      const layer = layers.find(l => l.id === selectedLayer);
      if (layer) {
        layer.color = selectedColor;
        renderLayerList();
        drawCanvas();
      }
    }

    // ãƒªã‚»ãƒƒãƒˆ
    function resetAll() {
      layers.forEach(layer => {
        if (layer.isBackground) {
          layer.color = '#ffffff';
        } else {
          layer.color = null;
        }
      });
      renderLayerList();
      drawCanvas();
    }

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
    function drawCanvas() {
      if (Object.keys(loadedImages).length === 0) return;

      const firstImg = loadedImages[1];
      if (firstImg) {
        // ç”»åƒã‚’åŠåˆ†ã®ã‚µã‚¤ã‚ºã«è¨­å®š
        canvas.width = firstImg.width / 2;
        canvas.height = firstImg.height / 2;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æç”»
      layers.forEach(layer => {
        if (!layer.visible) return;

        if (layer.isBackground) {
          ctx.fillStyle = layer.color || '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          return;
        }

        const img = loadedImages[layer.id];
        if (!img) return;

        if (layer.color) {
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = canvas.width;
          tempCanvas.height = canvas.height;
          const tempCtx = tempCanvas.getContext('2d');
          
          tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          
          const rgb = hexToRgb(layer.color);
          
          for (let i = 0; i < data.length; i += 4) {
            if (data[i + 3] > 0) {
              data[i] = rgb.r;
              data[i + 1] = rgb.g;
              data[i + 2] = rgb.b;
            }
          }
          
          tempCtx.putImageData(imageData, 0, 0);
          ctx.drawImage(tempCanvas, 0, 0);
        } else {
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
      });

      // å›ºå®šãƒ¬ã‚¤ãƒ¤ãƒ¼(æœ€ä¸Šä½)
      if (fixedLayerVisible) {
        const img = loadedImages[1];
        if (img) ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      }
    }

    // Hex to RGBå¤‰æ›
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : { r: 255, g: 255, b: 255 };
    }

    // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'coloring_contest.png';
      link.href = canvas.toDataURL();
      link.click();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      document.getElementById('applyColorBtn').onclick = applyColor;
      document.getElementById('resetBtn').onclick = resetAll;
      document.getElementById('downloadBtn').onclick = downloadImage;
      customColorInput.oninput = (e) => {
        selectedColor = e.target.value;
        updatePaletteSelection();
      };
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>