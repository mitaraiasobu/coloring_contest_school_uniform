<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¨ å¡—ã‚Šçµµã‚³ãƒ³ãƒ†ã‚¹ãƒˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-6">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-8 text-purple-800">
      ğŸ¨ å¡—ã‚Šçµµã‚³ãƒ³ãƒ†ã‚¹ãƒˆ
    </h1>

    
    <!-- ä¸Šéƒ¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒãƒ¼ -->
    <div id="topDownloadBar" class="relative mb-6">
      <div class="bg-white/80 backdrop-blur rounded-xl shadow-lg border border-purple-100 p-4 lg:p-5">
        <button id="closeTopDownloadBar" class="absolute -top-2 -right-2 w-9 h-9 rounded-full bg-gray-800 text-white shadow-md hover:bg-gray-700 transition flex items-center justify-center" aria-label="é–‰ã˜ã‚‹">
          âœ•
        </button>
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
          <a
            href="https://www.dropbox.com/scl/fi/n13n83mqwtiwywacephep/school_uniform_4.png?rlkey=oxty5v4n90824d0ns8s17lnt9&st=0t1vqzda&dl=0"
            target="_blank" rel="noopener noreferrer"
            class="w-full inline-flex items-center justify-center gap-2 text-base lg:text-lg font-bold px-5 py-4 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition shadow"
          >
            â¬‡ï¸ å¡—ã‚‹å‰ã®ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </a>
          <a
            href="https://www.dropbox.com/scl/fi/mpzj8h3v5s3ld0tc44eko/mitaraiasobu_nurie.psd?rlkey=ypbedwxtmghoibcrh458yz68s&st=oil5j8ix&dl=0"
            target="_blank" rel="noopener noreferrer"
            class="w-full inline-flex items-center justify-center gap-2 text-base lg:text-lg font-bold px-5 py-4 rounded-xl bg-gray-900 text-white hover:bg-black transition shadow"
          >
            â¬‡ï¸ PSDãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </a>
        </div>
        <p class="mt-3 text-xs lg:text-sm text-gray-600">
          â€»ä¸è¦ãªå ´åˆã¯å³ä¸Šã®ã€Œâœ•ã€ã§éè¡¨ç¤ºã«ã§ãã¾ã™
        </p>
      </div>
    </div>

    <!-- èª­ã¿è¾¼ã¿çŠ¶æ…‹ -->
    <div id="loadingStatus" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6 hidden">
      <p class="text-yellow-700">â³ ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div id="errorStatus" class="bg-red-100 border-l-4 border-red-500 p-4 mb-6 hidden">
      <p class="text-red-700 font-bold">âŒ ä¸€éƒ¨ã®ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>
      <ul id="errorList" class="text-sm text-red-600 ml-7 mt-2"></ul>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <div id="debugInfo" class="bg-blue-100 border-l-4 border-blue-500 p-4 mb-6">
      <p class="text-blue-700 font-bold mb-2">ğŸ“Š ç”»åƒèª­ã¿è¾¼ã¿çŠ¶æ…‹:</p>
      <div id="imageStatus" class="grid grid-cols-4 gap-2 text-sm"></div>
      <p id="loadCount" class="text-blue-600 text-sm mt-2"></p>
      <p id="pathInfo" class="text-blue-600 text-xs mt-2"></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
      <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ -->
      <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6">
        <div class="border-4 border-purple-200 rounded-lg overflow-hidden bg-white">
          <canvas id="canvas" class="w-full h-auto max-w-full"></canvas>
        </div>
        
        <div class="mt-4 flex flex-col gap-2">
          <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center justify-between">
            <!-- å·¦:ã¿ã‚“ãªã®ä½œå“ã‚’è¦‹ã‚‹ -->
            <a
              href="https://x.com/search?q=%23%E5%BE%A1%E6%89%8B%E6%B4%97%E3%81%BF%E3%81%9F%E3%82%89&src=hashtag_click&f=live"
              target="_blank" rel="noopener noreferrer"
              class="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm lg:text-base font-bold px-4 py-3 rounded-lg bg-pink-500 text-white hover:bg-pink-600 transition-colors shadow"
            >
              ğŸ‘€ ã¿ã‚“ãªã®ä½œå“ã‚’è¦‹ã‚‹
            </a>

            <!-- å³:ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ / æŠ•ç¨¿ -->
            <div class="flex flex-col sm:flex-row gap-2 justify-end">
              <button id="downloadBtn" class="flex items-center justify-center gap-2 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm lg:text-base">
                ğŸ“¥ ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              </button>
              <button id="tweetBtn" class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm lg:text-base">
                ğŸ¦ Twitterã«æŠ•ç¨¿
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
      <div class="grid grid-cols-2 gap-4 lg:grid-cols-1 lg:space-y-0 lg:gap-6">
        <!-- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ -->
        <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6 col-span-2 lg:col-span-1">
          <h2 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4">ğŸ¨ ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ</h2>
          
          <!-- è‰²ç›¸ãƒãƒ¼ -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">ğŸŒˆ è‰²ç›¸</label>
            <div class="relative w-full h-8 mb-3">
              <canvas id="colorBar" class="w-full h-full cursor-pointer rounded"></canvas>
              <div id="colorCursor" class="absolute w-1 h-10 bg-white rounded-sm shadow-lg pointer-events-none border-2 border-gray-800" style="top: 50%; left: 0%; transform: translate(-50%, -50%);"></div>
            </div>
            
            <!-- æ˜åº¦ãƒ»å½©åº¦èª¿æ•´ -->
            <div class="space-y-2 mb-3">
              <div>
                <label class="block text-xs font-medium mb-1">ğŸ’¡ æ˜åº¦</label>
                <input type="range" id="brightnessSlider" min="0" max="100" value="50" class="w-full">
              </div>
              <div>
                <label class="block text-xs font-medium mb-1">âœ¨ å½©åº¦</label>
                <input type="range" id="saturationSlider" min="0" max="100" value="100" class="w-full">
              </div>
            </div>
            
            <!-- ç¾åœ¨ã®è‰²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="flex items-center gap-2 mb-3">
              <div id="currentColorPreview" class="w-12 h-12 rounded border-2 border-gray-300" style="background-color: #ff0000;"></div>
              <div class="flex-grow">
                <input type="text" id="hexInput" value="#ff0000" class="w-full px-2 py-1 text-sm border rounded" placeholder="#000000">
              </div>
              <button id="addToPaletteBtn" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600 transition-colors">
                â• ç™»éŒ²
              </button>
            </div>
          </div>

          <!-- è‡ªä½œãƒ‘ãƒ¬ãƒƒãƒˆ -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label class="block text-sm font-medium">ğŸ’¾ ãƒã‚¤ãƒ‘ãƒ¬ãƒƒãƒˆ</label>
              <button id="resetPaletteBtn" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 transition-colors">
                ğŸ—‘ï¸ ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
            <div id="customPalette" class="grid grid-cols-6 gap-2 min-h-[40px] p-2 bg-gray-50 rounded border-2 border-dashed border-gray-300"></div>
          </div>
          
          <button id="applyColorBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition-colors text-sm lg:text-base">
            é¸æŠã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¡—ã‚‹
          </button>
        </div>

        <!-- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ« -->
        <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6 col-span-2 lg:col-span-1">
          <div class="flex justify-between items-center mb-3 lg:mb-4">
            <h2 class="text-lg lg:text-xl font-bold">ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>
            <button id="resetBtn" class="text-xs lg:text-sm bg-gray-200 px-3 py-2 rounded hover:bg-gray-300 transition-colors">
              ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
          <div id="layerList" class="space-y-2 max-h-64 lg:max-h-96 overflow-y-auto"></div>
        </div>
      </div>
    </div>

    <!-- ä½¿ã„æ–¹ -->
    <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
      <h3 class="text-lg font-bold mb-3">ğŸ“– ä½¿ã„æ–¹</h3>
      <ol class="list-decimal list-inside space-y-2 text-gray-700">
        <li>è‰²ç›¸ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è‰²ã‚’é¸ã³ã€æ˜åº¦ãƒ»å½©åº¦ã§èª¿æ•´</li>
        <li>æ°—ã«å…¥ã£ãŸè‰²ãŒã§ããŸã‚‰ã€Œâ• ç™»éŒ²ã€ã§ãƒã‚¤ãƒ‘ãƒ¬ãƒƒãƒˆã«ä¿å­˜</li>
        <li>ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã‹ã‚‰å¡—ã‚ŠãŸã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ(ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã¯å›ºå®šã§å¤‰æ›´ä¸å¯)</li>
        <li>ã€Œé¸æŠã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¡—ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
        <li>ğŸ‘ï¸ ã‚¢ã‚¤ã‚³ãƒ³ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ</li>
        <li>å®Œæˆã—ãŸã‚‰ã€Œç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã¾ãŸã¯ã€ŒTwitterã«æŠ•ç¨¿ã€</li>
      </ol>
    </div>

    <!-- ä¸‹éƒ¨ãƒ—ãƒ­ãƒ¢ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ -->
    <section class="mt-10">
      <h2 class="text-lg lg:text-xl font-extrabold text-gray-800 mb-4">ã»ã‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ãƒã‚§ãƒƒã‚¯</h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <button class="promoThumb group" data-full="./images/ã‚¤ãƒ©ã‚³ãƒ³2.png" aria-label="ã‚¤ãƒ©ã‚³ãƒ³2ã‚’æ‹¡å¤§" type="button">
          <img src="./images/ã‚¤ãƒ©ã‚³ãƒ³2.png" alt="ã‚¤ãƒ©ã‚³ãƒ³2" class="w-full h-auto rounded-xl shadow border border-gray-200 group-hover:opacity-90 transition max-w-[50%] mx-auto" loading="lazy">
        </button>

        <button class="promoThumb group" data-full="./images/åˆ‡ã‚ŠæŠœãå‹•ç”»ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ.png" aria-label="åˆ‡ã‚ŠæŠœãå‹•ç”»ã‚³ãƒ³ãƒ†ã‚¹ãƒˆã‚’æ‹¡å¤§" type="button">
          <img src="./images/åˆ‡ã‚ŠæŠœãå‹•ç”»ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ.png" alt="åˆ‡ã‚ŠæŠœãå‹•ç”»ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ" class="w-full h-auto rounded-xl shadow border border-gray-200 group-hover:opacity-90 transition max-w-[50%] mx-auto" loading="lazy">
        </button>
      </div>
      <p class="mt-3 text-xs lg:text-sm text-gray-600">ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ‹¡å¤§è¡¨ç¤ºã§ãã¾ã™ã€‚</p>
    </section>

    <!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="imageModal" class="fixed inset-0 z-[9999] hidden">
      <div id="imageModalBackdrop" class="absolute inset-0 bg-black/70"></div>
      <div class="relative w-full h-full flex flex-col items-center justify-center p-4">
        <button id="imageModalClose" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/90 text-gray-900 shadow hover:bg-white transition flex items-center justify-center" aria-label="é–‰ã˜ã‚‹">
          âœ•
        </button>
        
        <!-- æ‹¡å¤§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="absolute top-4 left-4 bg-white/90 rounded-lg p-3 shadow-lg">
          <div class="flex items-center gap-3">
            <span class="text-sm font-medium text-gray-700">ğŸ” æ‹¡å¤§</span>
            <input type="range" id="zoomSlider" min="50" max="300" value="100" class="w-32">
            <span id="zoomPercent" class="text-sm font-medium text-gray-700 w-12">100%</span>
            <button id="resetZoom" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
        
        <!-- ç”»åƒã‚³ãƒ³ãƒ†ãƒŠ(ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½) -->
        <div class="flex-1 overflow-auto flex items-center justify-center w-full">
          <img id="imageModalImg" src="" alt="" class="rounded-xl shadow-2xl border border-white/20 transition-transform" style="max-width: none; max-height: none; transform: scale(1);">
        </div>
      </div>
    </div>
  </div>

  <script>
    // ç”»åƒURLã®è¨­å®š
    const layerImageUrls = {
      1: './images/1.png',
      2: './images/2.png',
      3: './images/3.png',
      4: './images/4.png',
      5: './images/5.png',
      6: './images/6.png',
      7: './images/7.png',
      8: './images/8.png',
      9: './images/9.png',
      10: './images/10.png',
      11: './images/11.png',
      12: './images/12.png',
      13: './images/13.png',
    };

    // çŠ¶æ…‹ç®¡ç†
    let selectedColor = '#ff0000';
    let selectedLayer = 'background';
    let loadedImages = {};
    let imageLoadStatus = {};
    let customPalette = [];
    let currentHue = 0;
    let currentSaturation = 100;
    let currentBrightness = 50;
    let layers = [
      { id: 'background', name: 'èƒŒæ™¯', color: '#ffffff', visible: true, isBackground: true },
      { id: 2, name: 'å¸½å­', color: null, visible: true },
      { id: 3, name: 'ãƒ•ãƒªãƒ«', color: null, visible: true },
      { id: 4, name: 'ãƒ©ã‚¤ãƒ³', color: null, visible: true },
      { id: 5, name: 'èƒ¸ãƒªãƒœãƒ³', color: null, visible: true },
      { id: 6, name: 'ä¸Šç€', color: null, visible: true },
      { id: 7, name: 'é´ä¸‹ãƒªãƒœãƒ³', color: null, visible: true },
      { id: 8, name: 'é´ä¸‹', color: null, visible: true },
      { id: 9, name: 'ã‚¹ã‚«ãƒ¼ãƒˆ', color: null, visible: true },
      { id: 10, name: 'é´', color: null, visible: true },
      { id: 11, name: 'é«ªãƒªãƒœãƒ³', color: null, visible: true },
      { id: 12, name: 'ã‚¤ãƒ¤ãƒªãƒ³ã‚°', color: null, visible: true },
      { id: 13, name: 'è¥Ÿ', color: null, visible: true },
    ];
    let fixedLayerVisible = true;

    // DOMã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const colorBar = document.getElementById('colorBar');
    const colorBarCtx = colorBar.getContext('2d');
    const brightnessSlider = document.getElementById('brightnessSlider');
    const saturationSlider = document.getElementById('saturationSlider');
    const hexInput = document.getElementById('hexInput');
    const currentColorPreview = document.getElementById('currentColorPreview');
    const colorCursor = document.getElementById('colorCursor');

    // åˆæœŸåŒ–
    function init() {
      loadPaletteFromCache();
      loadImages();
      drawColorBar();
      renderCustomPalette();
      renderLayerList();
      setupEventListeners();
      updateCurrentColor();
      setTimeout(updateColorCursorPosition, 100);
    }

    // ç”»åƒã‚’èª­ã¿è¾¼ã‚€
    function loadImages() {
      document.getElementById('loadingStatus').classList.remove('hidden');
      document.getElementById('pathInfo').textContent = `ç”»åƒãƒ‘ã‚¹ä¾‹: ${layerImageUrls[1]}`;
      let loadCount = 0;
      const totalImages = Object.keys(layerImageUrls).length;

      Object.entries(layerImageUrls).forEach(([id, url]) => {
        imageLoadStatus[id] = 'loading';
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = () => {
          loadedImages[id] = img;
          imageLoadStatus[id] = 'loaded';
          loadCount++;
          updateLoadStatus(loadCount, totalImages);
          
          if (loadCount === totalImages) {
            document.getElementById('loadingStatus').classList.add('hidden');
            const hasErrors = Object.values(imageLoadStatus).some(s => s === 'error');
            if (!hasErrors) {
              document.getElementById('debugInfo').classList.add('hidden');
            }
            drawCanvas();
          }
        };
        
        img.onerror = (e) => {
          console.error(`ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - ãƒ¬ã‚¤ãƒ¤ãƒ¼${id}: ${url}`, e);
          imageLoadStatus[id] = 'error';
          loadCount++;
          updateLoadStatus(loadCount, totalImages);
          
          if (loadCount === totalImages) {
            document.getElementById('loadingStatus').classList.add('hidden');
            showErrors();
          }
        };
        
        img.src = url;
      });
    }

    // èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’æ›´æ–°
    function updateLoadStatus(loaded, total) {
      const statusDiv = document.getElementById('imageStatus');
      statusDiv.innerHTML = '';
      
      Object.entries(imageLoadStatus).forEach(([id, status]) => {
        const div = document.createElement('div');
        div.className = 'text-blue-600';
        const emoji = status === 'loaded' ? 'âœ…' : status === 'loading' ? 'â³' : 'âŒ';
        div.textContent = `ãƒ¬ã‚¤ãƒ¤ãƒ¼${id}: ${emoji}`;
        statusDiv.appendChild(div);
      });
      
      document.getElementById('loadCount').textContent = 
        `èª­ã¿è¾¼ã¿æ¸ˆã¿: ${Object.values(imageLoadStatus).filter(s => s === 'loaded').length} / ${total}`;
    }

    // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    function showErrors() {
      const errors = Object.entries(imageLoadStatus).filter(([_, status]) => status === 'error');
      if (errors.length > 0) {
        document.getElementById('errorStatus').classList.remove('hidden');
        const errorList = document.getElementById('errorList');
        errorList.innerHTML = '';
        errors.forEach(([id]) => {
          const li = document.createElement('li');
          li.textContent = `ãƒ¬ã‚¤ãƒ¤ãƒ¼${id}: ${layerImageUrls[id]} - èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼`;
          errorList.appendChild(li);
        });
      }
      drawCanvas();
    }

    // è‰²ç›¸ãƒãƒ¼ã‚’æç”»
    function drawColorBar() {
      const width = colorBar.parentElement.offsetWidth;
      const height = 32;
      colorBar.width = width;
      colorBar.height = height;

      const gradient = colorBarCtx.createLinearGradient(0, 0, width, 0);
      for (let i = 0; i <= 360; i += 30) {
        gradient.addColorStop(i / 360, `hsl(${i}, 100%, 50%)`);
      }
      
      colorBarCtx.fillStyle = gradient;
      colorBarCtx.fillRect(0, 0, width, height);
    }

    // è‰²ç›¸ãƒãƒ¼ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ›´æ–°
    function updateColorCursorPosition() {
      const barContainer = colorBar.parentElement;
      const rect = barContainer.getBoundingClientRect();
      const x = (currentHue / 360) * rect.width;
      
      colorCursor.style.left = `${x}px`;
    }

    // è‰²ç›¸ãƒãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    colorBar.addEventListener('click', (e) => {
      const rect = colorBar.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const hue = Math.round((x / rect.width) * 360);
      
      currentHue = Math.min(360, Math.max(0, hue));
      updateCurrentColor();
    });

    // HSLã‹ã‚‰HEXã¸å¤‰æ›
    function hslToHex(h, s, l) {
      s /= 100;
      l /= 100;
      const a = s * Math.min(l, 1 - l);
      const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color).toString(16).padStart(2, '0');
      };
      return `#${f(0)}${f(8)}${f(4)}`;
    }

    // ç¾åœ¨ã®è‰²ã‚’æ›´æ–°
    function updateCurrentColor() {
      const hex = hslToHex(currentHue, currentSaturation, currentBrightness);
      selectedColor = hex;
      currentColorPreview.style.backgroundColor = hex;
      hexInput.value = hex;
      updateColorCursorPosition();
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
    brightnessSlider.addEventListener('input', (e) => {
      currentBrightness = parseInt(e.target.value);
      updateCurrentColor();
    });

    saturationSlider.addEventListener('input', (e) => {
      currentSaturation = parseInt(e.target.value);
      updateCurrentColor();
    });

    // HEXå…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    hexInput.addEventListener('input', (e) => {
      const hex = e.target.value;
      if (/^#[0-9A-F]{6}$/i.test(hex)) {
        selectedColor = hex;
        currentColorPreview.style.backgroundColor = hex;
        
        const rgb = hexToRgb(hex);
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        currentHue = hsl.h;
        currentSaturation = hsl.s;
        currentBrightness = hsl.l;
        brightnessSlider.value = currentBrightness;
        saturationSlider.value = currentSaturation;
      }
    });

    // RGBã‹ã‚‰HSLã¸å¤‰æ›
    function rgbToHsl(r, g, b) {
      r /= 255;
      g /= 255;
      b /= 255;
      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0;
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
          case g: h = ((b - r) / d + 2) / 6; break;
          case b: h = ((r - g) / d + 4) / 6; break;
        }
      }

      return {
        h: Math.round(h * 360),
        s: Math.round(s * 100),
        l: Math.round(l * 100)
      };
    }

    // è‡ªä½œãƒ‘ãƒ¬ãƒƒãƒˆã«è‰²ã‚’è¿½åŠ 
    function addToCustomPalette() {
      if (!customPalette.includes(selectedColor)) {
        customPalette.push(selectedColor);
        savePaletteToCache();
        renderCustomPalette();
      }
    }

    // è‡ªä½œãƒ‘ãƒ¬ãƒƒãƒˆã‚’æç”»
    function renderCustomPalette() {
      const paletteDiv = document.getElementById('customPalette');
      paletteDiv.innerHTML = '';
      
      if (customPalette.length === 0) {
        paletteDiv.innerHTML = '<div class="col-span-6 text-center text-gray-400 text-sm py-2">è‰²ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>';
        return;
      }
      
      customPalette.forEach((color, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'relative group';
        
        const btn = document.createElement('button');
        btn.className = 'w-full aspect-square rounded border-2 border-gray-300 transition-transform hover:scale-110';
        btn.style.backgroundColor = color;
        btn.onclick = () => {
          selectedColor = color;
          currentColorPreview.style.backgroundColor = color;
          hexInput.value = color;
          
          const rgb = hexToRgb(color);
          const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
          currentHue = hsl.h;
          currentSaturation = hsl.s;
          currentBrightness = hsl.l;
          brightnessSlider.value = currentBrightness;
          saturationSlider.value = currentSaturation;
          updateColorCursorPosition();
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs opacity-0 group-hover:opacity-100 transition-opacity';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          customPalette.splice(index, 1);
          savePaletteToCache();
          renderCustomPalette();
        };
        
        wrapper.appendChild(btn);
        wrapper.appendChild(deleteBtn);
        paletteDiv.appendChild(wrapper);
      });
    }

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»
    function renderLayerList() {
      const listDiv = document.getElementById('layerList');
      listDiv.innerHTML = '';

      // å›ºå®šãƒ¬ã‚¤ãƒ¤ãƒ¼(ãƒ¬ã‚¤ãƒ¤ãƒ¼1)
      const fixedDiv = document.createElement('div');
      fixedDiv.className = 'flex items-center gap-2 p-3 rounded-lg border-2 border-gray-400 bg-gray-100';
      fixedDiv.innerHTML = `
        <button onclick="toggleFixedLayer()" class="flex-shrink-0">
          ${fixedLayerVisible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
        </button>
        <div class="w-8 h-8 rounded border-2 border-gray-300 flex-shrink-0 bg-white"></div>
        <span class="font-medium flex-grow">ãƒ¬ã‚¤ãƒ¤ãƒ¼1(å›ºå®š)</span>
        <span class="text-xs text-gray-500">ğŸ”’</span>
      `;
      listDiv.appendChild(fixedDiv);

      // ãã®ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼
      layers.forEach(layer => {
        const div = document.createElement('div');
        const isSelected = selectedLayer === layer.id;
        div.className = `flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer transition-colors ${
          isSelected ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-gray-300'
        }`;
        div.onclick = () => selectLayer(layer.id);
        
        div.innerHTML = `
          <button onclick="event.stopPropagation(); toggleLayerVisibility('${layer.id}')" class="flex-shrink-0">
            ${layer.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
          </button>
          <div class="w-8 h-8 rounded border-2 border-gray-300 flex-shrink-0" style="background-color: ${layer.color || '#ffffff'}"></div>
          <span class="font-medium flex-grow">${layer.name}</span>
        `;
        listDiv.appendChild(div);
      });
    }

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ
    function selectLayer(layerId) {
      selectedLayer = layerId;
      renderLayerList();
      updateApplyButton();
    }

    // é©ç”¨ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateApplyButton() {
      const btn = document.getElementById('applyColorBtn');
      if (selectedLayer === 1) {
        btn.className = 'w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-bold cursor-not-allowed text-sm lg:text-base';
        btn.textContent = 'å›ºå®šãƒ¬ã‚¤ãƒ¤ãƒ¼(å¤‰æ›´ä¸å¯)';
        btn.disabled = true;
      } else {
        btn.className = 'w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition-colors text-sm lg:text-base';
        btn.textContent = 'é¸æŠã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¡—ã‚‹';
        btn.disabled = false;
      }
    }

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    window.toggleLayerVisibility = function(layerId) {
      const layer = layers.find(l => l.id == layerId);
      if (layer) {
        layer.visible = !layer.visible;
        renderLayerList();
        drawCanvas();
      }
    };

    // å›ºå®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
    window.toggleFixedLayer = function() {
      fixedLayerVisible = !fixedLayerVisible;
      renderLayerList();
      drawCanvas();
    };

    // è‰²ã‚’é©ç”¨
    function applyColor() {
      if (selectedLayer === 1) return;
      
      const layer = layers.find(l => l.id === selectedLayer);
      if (layer) {
        layer.color = selectedColor;
        renderLayerList();
        drawCanvas();
      }
    }

    // ãƒªã‚»ãƒƒãƒˆ
    function resetAll() {
      layers.forEach(layer => {
        if (layer.isBackground) {
          layer.color = '#ffffff';
        } else {
          layer.color = null;
        }
      });
      renderLayerList();
      drawCanvas();
    }

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
    function drawCanvas() {
      if (Object.keys(loadedImages).length === 0) return;

      const firstImg = loadedImages[1];
      if (firstImg) {
        canvas.width = firstImg.width / 2;
        canvas.height = firstImg.height / 2;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æç”»
      layers.forEach(layer => {
        if (!layer.visible) return;

        if (layer.isBackground) {
          ctx.fillStyle = layer.color || '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          return;
        }

        const img = loadedImages[layer.id];
        if (!img) return;

        if (layer.color) {
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = canvas.width;
          tempCanvas.height = canvas.height;
          const tempCtx = tempCanvas.getContext('2d');
          
          tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          
          const rgb = hexToRgb(layer.color);
          
          for (let i = 0; i < data.length; i += 4) {
            if (data[i + 3] > 0) {
              data[i] = rgb.r;
              data[i + 1] = rgb.g;
              data[i + 2] = rgb.b;
            }
          }
          
          tempCtx.putImageData(imageData, 0, 0);
          ctx.drawImage(tempCanvas, 0, 0);
        } else {
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
      });

      // å›ºå®šãƒ¬ã‚¤ãƒ¤ãƒ¼(æœ€ä¸Šä½)
      if (fixedLayerVisible) {
        const img = loadedImages[1];
        if (img) ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      }
    }

    // Hex to RGBå¤‰æ›
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : { r: 255, g: 255, b: 255 };
    }

    // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'coloring_contest.png';
      link.href = canvas.toDataURL();
      link.click();
    }

    // Twitterã«æŠ•ç¨¿
    function tweetImage() {
      const link = document.createElement('a');
      link.download = 'coloring_contest.png';
      link.href = canvas.toDataURL();
      link.click();

      const tweetText = encodeURIComponent('#å¾¡æ‰‹æ´—ã¿ãŸã‚‰? å¾¡æ‰‹æ´—éŠ æ–°è¡£è£… å¡—ã‚Šçµµã‚³ãƒ³ãƒ†ã‚¹ãƒˆã«å‚åŠ ã—ã¾ã—ãŸ!\n(ç”»åƒãŒè‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚ç”»åƒã‚’æ·»ä»˜ã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„!)');
      
      const twitterUrl = `https://twitter.com/intent/tweet?text=${tweetText}`;
      window.open(twitterUrl, '_blank');
    }

    // ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜(ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿ä¿æŒ)
    function savePaletteToCache() {
      try {
        localStorage.setItem('coloringContestPalette', JSON.stringify(customPalette));
      } catch (e) {
        console.log('ãƒ‘ãƒ¬ãƒƒãƒˆã®ä¿å­˜: localStorageä½¿ç”¨ä¸å¯(ãƒ¡ãƒ¢ãƒªå†…ã«ä¿æŒ)');
      }
    }

    // ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿
    function loadPaletteFromCache() {
      try {
        const saved = localStorage.getItem('coloringContestPalette');
        if (saved) {
          customPalette = JSON.parse(saved);
        }
      } catch (e) {
        console.log('ãƒ‘ãƒ¬ãƒƒãƒˆã®èª­ã¿è¾¼ã¿: localStorageä½¿ç”¨ä¸å¯');
      }
    }

    // ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetPalette() {
      if (customPalette.length === 0) {
        alert('ãƒã‚¤ãƒ‘ãƒ¬ãƒƒãƒˆã¯ç©ºã§ã™ã€‚');
        return;
      }
      
      if (confirm('ãƒã‚¤ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹?\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        customPalette = [];
        savePaletteToCache();
        renderCustomPalette();
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°(ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—)
    let currentZoom = 100;
    
    function openImageModal(src, altText) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('imageModalImg');
      if (!modal || !modalImg) return;
      modalImg.src = src;
      modalImg.alt = altText || '';
      modal.classList.remove('hidden');
      currentZoom = 100;
      updateZoom();
    }
    
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('imageModalImg');
      if (!modal || !modalImg) return;
      modal.classList.add('hidden');
      modalImg.src = '';
      modalImg.alt = '';
      currentZoom = 100;
    }
    
    function updateZoom() {
      const modalImg = document.getElementById('imageModalImg');
      const zoomSlider = document.getElementById('zoomSlider');
      const zoomPercent = document.getElementById('zoomPercent');
      
      if (modalImg) {
        modalImg.style.transform = `scale(${currentZoom / 100})`;
      }
      if (zoomSlider) {
        zoomSlider.value = currentZoom;
      }
      if (zoomPercent) {
        zoomPercent.textContent = `${currentZoom}%`;
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupEventListeners() {
      document.getElementById('applyColorBtn').onclick = applyColor;
      document.getElementById('resetBtn').onclick = resetAll;
      document.getElementById('downloadBtn').onclick = downloadImage;
      document.getElementById('tweetBtn').onclick = tweetImage;
      document.getElementById('addToPaletteBtn').onclick = addToCustomPalette;
      document.getElementById('resetPaletteBtn').onclick = resetPalette;
      
      // ä¸Šéƒ¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      const closeBtn = document.getElementById('closeTopDownloadBar');
      const topBar = document.getElementById('topDownloadBar');
      if (closeBtn && topBar) {
        closeBtn.onclick = () => {
          topBar.classList.add('hidden');
        };
      }
      
      // ãƒ—ãƒ­ãƒ¢ç”»åƒ:ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§è¡¨ç¤º
      document.querySelectorAll('.promoThumb').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const full = btn.getAttribute('data-full');
          const img = btn.querySelector('img');
          const altText = img ? img.alt : '';
          openImageModal(full, altText);
        });
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      const modalClose = document.getElementById('imageModalClose');
      const modalBackdrop = document.getElementById('imageModalBackdrop');
      
      if (modalClose) {
        modalClose.addEventListener('click', closeImageModal);
      }
      if (modalBackdrop) {
        modalBackdrop.addEventListener('click', closeImageModal);
      }
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeImageModal();
      });
      
      // ã‚ºãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
      const zoomSlider = document.getElementById('zoomSlider');
      const resetZoom = document.getElementById('resetZoom');
      
      if (zoomSlider) {
        zoomSlider.addEventListener('input', (e) => {
          currentZoom = parseInt(e.target.value);
          updateZoom();
        });
      }
      
      if (resetZoom) {
        resetZoom.addEventListener('click', () => {
          currentZoom = 100;
          updateZoom();
        });
      }
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
